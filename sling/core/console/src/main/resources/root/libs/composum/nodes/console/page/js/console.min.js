var $jscomp={scope:{},findInternal:function(b,d,a){b instanceof String&&(b=String(b));for(var c=b.length,e=0;e<c;e++){var f=b[e];if(d.call(a,f,e,b))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(b,d,a){if(a.get||a.set)throw new TypeError("ES3 does not support getters and setters.");b!=Array.prototype&&b!=Object.prototype&&(b[d]=a.value)};
$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,d,a,c){if(d){a=$jscomp.global;b=b.split(".");for(c=0;c<b.length-1;c++){var e=b[c];e in a||(a[e]={});a=a[e]}b=b[b.length-1];c=a[b];d=d(c);d!=c&&null!=d&&$jscomp.defineProperty(a,b,{configurable:!0,writable:!0,value:d})}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,a){return $jscomp.findInternal(this,b,a).v}},"es6-impl","es3");
(function(b){b.console=b.console||{};b.initPermissions=function(){location.reload()};(function(d){d.getProfile=function(){return d.profile};d.getUserLoginDialog=function(){return b.getView("#user-status-dialog",d.UserLoginDialog)};d.authorize=function(a){d.getUserLoginDialog().show(void 0,a,"authorization")};d.profile=new b.LocalProfile("composum.core");d.UserLoginDialog=b.components.Dialog.extend({initialize:function(a){b.components.Dialog.prototype.initialize.apply(this,[a]);this.$content=this.$(".modal-content");
a=this.$("form");var c=this.$("button.login");a.on("submit",_.bind(this.login,this));c.click(_.bind(this.login,this));this.$("button.logout").click(_.bind(this.logout,this));this.$el.on("shown.bs.modal",_.bind(this.onShown,this))},show:function(a,c,e){this.$content.removeClass();this.$content.addClass("modal-content");e&&this.$content.addClass(e);b.components.Dialog.prototype.show.apply(this,[a,c])},onShown:function(){this.$('input[name="j_username"]').focus()},logout:function(a){a.preventDefault();
b.getHtml("/system/sling/logout.html",void 0,void 0,_.bind(function(a){this.hide();b.initPermissions()},this))},login:function(a){a.preventDefault();this.submitForm(void 0,!1,_.bind(function(){_.isFunction(this.callback)?this.hide():b.initPermissions()},this));return!1}});d.NavBar=Backbone.View.extend({el:$("header.navbar")[0],initialize:function(){var a=$("body").attr("id");this.$(".nav-item."+a).addClass("active");a=d.getUserLoginDialog();this.$(".nav-user-status").on("click",_.bind(a.show,a))}});
d.navbar=new b.console.NavBar;d.DetailTab=Backbone.View.extend({reload:function(){this.$el.closest(".detail-content")}});d.JobControlTab=d.DetailTab.extend({initialize:function(a){d.DetailTab.prototype.initialize.apply(this,[a])},reload:function(){this.setupStatus();this.resetAuditLog()},startJob:function(a){if(!this.currentJob){var c=this.getCurrentPath();this.delay();this.logOffset=0;b.ajaxPost("/bin/cpm/core/jobcontrol.job.json",_.extend({"event.job.topic":this.jobTopic,reference:c,_charset_:"UTF-8"},
a),{},_.bind(function(a,c,b){this.jobStarted(a);this.delay(!0)},this),_.bind(function(a){this.jobError("Job start failed: ",a)},this))}},cancelJob:function(){this.currentJob&&b.ajaxDelete("/bin/cpm/core/jobcontrol.job.json/"+this.currentJob["slingevent:eventId"],{},_.bind(function(a,c,b){this.logAppend("Job cancellation requested...\n");this.delay(!0)},this),_.bind(function(a){this.jobError("Job cancellation failed: ",a)},this))},setupStatus:function(){var a=this.getCurrentPath();b.ajaxGet("/bin/cpm/core/jobcontrol.jobs.ACTIVE.json"+
a+"?topic="+this.jobTopic,{},_.bind(function(a,b,d){a&&0<a.length?(this.jobStarted(a[0]),this.delay(!0)):this.currentJob=void 0},this),_.bind(function(a){this.jobError("Job status check failed: ",a)},this))},jobStarted:function(a){a&&(this.currentJob=a,a=this.currentJob.operation,this.logOffset=0,this.$logOutput.text(""),this.resetAuditLog(),this.removeClasses(/.+-error/),this.$el.addClass((a?a:"job")+"-running"))},jobStopped:function(a){a&&this.logAppend(a);this.currentJob&&(this.removeClasses(/.+-running/),
this.currentJob=void 0)},jobError:function(a,c){var b=this.currentJob.operation;this.$el.addClass((b?b:"job")+"-error");this.jobStopped(a+c.statusText+(c.status?" ("+c.status+")":"")+"\n");this.delay(!0)},jobSucceeded:function(){this.jobStopped("Job finished successfully.\n")},checkJob:function(){this.pollOutput(_.bind(function(){this.currentJob&&(b.ajaxGet("/bin/cpm/core/jobcontrol.job.json/"+this.currentJob["slingevent:eventId"],{},_.bind(function(a,c,b){this.currentJob=a;if(this.currentJob["slingevent:finishedState"])switch(this.currentJob["slingevent:finishedState"]){case "SUCCEEDED":this.jobSucceeded();
break;case "STOPPED":this.jobStopped("Job execution stopped.\n");break;case "ERROR":this.jobError("Job finished with 'Error': ",{statusText:this.currentJob["slingevent:resultMessage"]});break;default:this.jobStopped("Job execution finished with '"+this.currentJob["slingevent:finishedState"]+"'.\n")}},this),_.bind(function(a){this.jobError("Job status check failed: ",a)},this)),this.delay(!0))},this))},pollOutput:function(a,c){c||this.currentJob&&(c=this.currentJob["slingevent:eventId"]);c&&b.ajaxGet("/bin/cpm/core/jobcontrol.outfile.txt/"+
c,{headers:{Range:"bytes="+this.logOffset+"-"}},_.bind(function(c,b,d){b=parseInt(d.getResponseHeader("Content-Length"));this.logAppend(c);this.logOffset+=b;_.isFunction(a)&&a.call(this)},this),_.bind(function(c){this.logAppend("Job output retrieval failed: "+c.statusText+" ("+c.status+")\n");_.isFunction(a)&&a.call(this)},this))},removeClasses:function(a){var c=this.$el.attr("class");if(c)for(var c=c.toString().split(" "),b=0;b<c.length;b++)a.exec(c[b])&&this.$el.removeClass(c[b])},logAppend:function(a){if(a){var c=
this.$logOutput.parent(),b=c.height(),d=this.$logOutput[0].scrollHeight,d=c.scrollTop()>d-b-30;this.$logOutput.text(this.$logOutput.text()+a);d&&(d=this.$logOutput[0].scrollHeight,c.scrollTop(d-b))}},delay:function(a){this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0);a&&(this.timeout=setTimeout(_.bind(this.checkJob,this),"boolean"===typeof a?500:a))},resetAuditLog:function(){this.$auditList.find("li").removeClass("current")},loadAuditLog:function(a){a&&a.preventDefault();this.$auditList.html("");
a=this.getCurrentPath();b.ajaxGet("/bin/cpm/core/jobcontrol.jobs.ALL.json"+a+"?topic="+this.jobTopic,{},_.bind(function(a,b,d){for(b=0;b<a.length;b++)d=a[b].jobState,this.$auditList.append('<li class="'+(d?d.toLowerCase():"unknown")+(a[b].operation?" "+a[b].operation:"")+'"><a href="#" data-id="'+a[b]["slingevent:eventId"]+'"><span class="time created">'+a[b]["slingevent:created"]+'</span><span class="state">'+d+'</span><span class="time finished">'+a[b]["slingevent:finishedDate"]+"</span>"+(a[b].operation?
'<span class="operation">'+a[b].operation+"</span>":"")+'<span class="result">'+a[b]["slingevent:resultMessage"]+"</span></a></li>");this.$auditList.find("a").click(_.bind(this.loadAuditLogfile,this))},this),_.bind(function(a){this.logAppend("Audit Log load failed: "+a.statusText)},this))},loadAuditLogfile:function(a){a.preventDefault();this.resetAuditLog();var b=$(a.currentTarget);b.closest("li").addClass("current");this.$logOutput.text("");this.logOffset=0;this.pollOutput(_.bind(function(){this.logAppend(b.find(".result").text())},
this),b.data("id"))},purgeAuditLog:function(a){a&&a.preventDefault();var b=d.getPurgeAuditDialog();b.show(_.bind(function(){b.initDialog(this.jobTopic,this.getCurrentPath(),this.purgeAuditKeep?this.purgeAuditKeep:3)},this),_.bind(function(){this.loadAuditLog()},this))}});d.DetailView=Backbone.View.extend({getProfileId:function(){},getCurrentPath:function(){},getViewUri:function(){},getTabUri:function(a){},getTabTypes:function(){return[{selector:"> div",tabType:d.DetailTab}]},initialize:function(a){$(document).on("path:selected.DetailView",
_.bind(this.reload,this))},reload:function(){(this.path=this.getCurrentPath())?this.$el.load(this.getViewUri(),_.bind(function(){this.$detailView=this.$(".detail-view");this.$detailTabs=this.$detailView.find(".detail-tabs");this.$detailContent=this.$detailView.find(".detail-content");this.$detailTabs.find("a").click(_.bind(this.tabSelected,this));var a=b.console.getProfile().get(this.getProfileId(),"detailTab"),c;a&&(c=this.$detailView.find('a[data-group="'+a+'"]'));if(!c||1>c.length)c=this.$detailTabs.find("a");
c=c.attr("href").substring(1);this.selectTab(c,a);if(_.isFunction(this.onReload))this.onReload()},this)):this.$el.html("")},selectTab:function(a,c){a||(a="properties");var d=this.getCurrentPath();d&&(d=this.getTabUri(a)+window.core.encodePath(d),this.$detailContent.load(b.getContextUrl(d),_.bind(function(){this.$detailTabs.find("a.active").removeClass("active");var d=this.$detailTabs.find('a[href="#'+a+'"]');d.addClass("active");c||(c=d.attr("data-group"));b.console.getProfile().set(this.getProfileId(),
"detailTab",c);this.viewWidget=void 0;for(var d=this.getTabTypes(),e=0;!this.viewWidget&&e<d.length;e++){var g=d[e];this.viewWidget=b.getWidget(this.$detailContent,g.selector,g.tabType)}this.viewWidget&&_.isFunction(this.viewWidget.reload)&&this.viewWidget.reload()},this)))},tabSelected:function(a){a.preventDefault();a=$(a.currentTarget).closest("a").attr("href").substring(1);this.selectTab(a);return!1}})})(b.console)})(window.core);
