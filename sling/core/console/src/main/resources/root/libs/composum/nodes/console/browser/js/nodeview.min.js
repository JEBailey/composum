var $jscomp={scope:{},checkStringArgs:function(b,c,a){if(null==b)throw new TypeError("The 'this' value for String.prototype."+a+" must not be null or undefined");if(c instanceof RegExp)throw new TypeError("First argument to String.prototype."+a+" must not be a regular expression");return b+""}};
$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(b,c,a){if(a.get||a.set)throw new TypeError("ES3 does not support getters and setters.");b!=Array.prototype&&b!=Object.prototype&&(b[c]=a.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,c,a,d){if(c){a=$jscomp.global;b=b.split(".");for(d=0;d<b.length-1;d++){var e=b[d];e in a||(a[e]={});a=a[e]}b=b[b.length-1];d=a[b];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(a,b,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("String.prototype.endsWith",function(b){return b?b:function(b,a){var d=$jscomp.checkStringArgs(this,b,"endsWith");b+="";void 0===a&&(a=d.length);for(var e=Math.max(0,Math.min(a|0,d.length)),c=b.length;0<c&&0<e;)if(d[--e]!=b[--c])return!1;return 0>=c}},"es6-impl","es3");$jscomp.findInternal=function(b,c,a){b instanceof String&&(b=String(b));for(var d=b.length,e=0;e<d;e++){var f=b[e];if(c.call(a,f,e,b))return{i:e,v:f}}return{i:-1,v:void 0}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,a){return $jscomp.findInternal(this,b,a).v}},"es6-impl","es3");
(function(b){b.browser=b.browser||{};(function(c){c.DisplayTab=b.console.DetailTab.extend({pathPattern:/^(https?:\/\/[^/]+)?(\/.*)$/,urlPattern:/^(.*\/[^/]+)(\.[^.]+)$/,initialize:function(a){this.displayKey=a.displayKey;this.loadContent=a.loadContent;this.$mappedButton=this.$(".detail-toolbar .resolver");this.$pathPrefix=this.$(".detail-toolbar .prefix input");this.$selectors=this.$(".detail-toolbar .selectors input");this.$extension=this.$(".detail-toolbar .extension input");this.$suffix=this.$(".detail-toolbar .suffix input");
this.$parameters=this.$(".detail-toolbar .parameters input");this.$(".detail-toolbar .reload").click(_.bind(this.reload,this));this.$(".detail-toolbar .open").click(_.bind(this.open,this));this.$pathPrefix.val(b.console.getProfile().get(this.displayKey,"pathPrefix"));this.$pathPrefix.on("change.display",_.bind(this.onPrefixChange,this));this.$selectors.val(b.console.getProfile().get(this.displayKey,"selectors"));this.$selectors.on("change.display",_.bind(this.onSelectorsChange,this));this.$extension.val(b.console.getProfile().get(this.displayKey,
"extension"));this.$extension.on("change.display",_.bind(this.onExtensionChange,this));this.$suffix.val(b.console.getProfile().get(this.displayKey,"suffix"));this.$suffix.on("change.display",_.bind(this.onSuffixChange,this));this.$parameters.val(b.console.getProfile().get(this.displayKey,"parameters"));this.$parameters.on("change.display",_.bind(this.onParametersChange,this));this.$mappedButton.on("click.display",_.bind(this.toggleMapped,this));this.$mappedButton.addClass(b.console.getProfile().get(this.displayKey,
"mapped",!0)?"on":"off")},onPrefixChange:function(a){a=this.$pathPrefix.val();b.console.getProfile().set(this.displayKey,"pathPrefix",a)},onSelectorsChange:function(a){a=this.$selectors.val();b.console.getProfile().set(this.displayKey,"selectors",a)},onExtensionChange:function(a){a=this.$extension.val();b.console.getProfile().set(this.displayKey,"extension",a)},onSuffixChange:function(a){a=this.$suffix.val();b.console.getProfile().set(this.displayKey,"suffix",a)},onParametersChange:function(a){a=
this.$parameters.val();b.console.getProfile().set(this.displayKey,"parameters",a)},reload:function(){this.loadContent(this.getUrl())},open:function(a){window.open(this.getUrl())},isMapped:function(){return this.$mappedButton.hasClass("on")},toggleMapped:function(a){a.preventDefault();this.isMapped()?(this.$mappedButton.removeClass("on"),this.$mappedButton.addClass("off")):(this.$mappedButton.removeClass("off"),this.$mappedButton.addClass("on"));b.console.getProfile().set(this.displayKey,"mapped",
this.isMapped());this.reload();return!1},getSelectors:function(){return this.$selectors.val()},getUrl:function(){var a=this.$el.attr(this.isMapped()?"data-mapped":"data-path"),d=this.$pathPrefix.val();if(d){var b=this.pathPattern.exec(a);b&&1<b.length&&(a=b[1]?b[1]:"",a+=d+b[2])}(d=this.urlPattern.exec(a))&&(a=d[1]);if(b=this.getSelectors()){for(;0===b.indexOf(".");)b=b.substring(1);for(;b.endsWith(".");)b=b.substring(0,b.length-1);a+="."+b}(b=this.$extension.val())?"-"==b?b="":0!=b.indexOf(".")&&
(b="."+b):b=d?d[2]:".html";a+=b;if(d=this.$suffix.val())0!=d.indexOf("/")&&(d="/"+d),a+=d;if(d=this.$parameters.val())0===d.indexOf("?")&&(d=d.substring(1)),a+="?"+d;return a}});c.HtmlTab=c.DisplayTab.extend({initialize:function(a){a=_.extend(a,{displayKey:"htmlView",loadContent:function(a){this.busy=!0;this.$iframe.attr("src",a)}});c.DisplayTab.prototype.initialize.apply(this,[a]);this.$iframe=this.$(".embedded iframe");this.$iframe.on("load.preview",_.bind(this.onFrameLoad,this))},onFrameLoad:function(a){this.busy?
this.busy=!1:(this.busy=!0,b.ajaxGet("/bin/cpm/nodes/node.resolve.json",{data:{url:a.currentTarget.contentDocument.URL}},_.bind(function(a){c.tree.selectNode(a.path,void 0,!0)},this),void 0,_.bind(function(a){this.busy=!1},this)))}});c.ImageTab=c.DisplayTab.extend({initialize:function(a){this.isAsset=!!this.$el.data("asset");a=_.extend(a,{displayKey:"imageView",loadContent:function(a){this.$image.attr("src",b.getContextUrl(a))}});c.DisplayTab.prototype.initialize.apply(this,[a]);this.$image=this.$(".image-frame img")},
getSelectors:function(){var a=this.$selectors.val();return this.isAsset?a||"asset":a}});c.VideoTab=c.DisplayTab.extend({initialize:function(a){a=_.extend(a,{displayKey:"videoView",loadContent:function(a){var d=this.$el.attr("data-type");this.$source.attr("type",d);this.$source.attr("src",b.getContextUrl(a))}});c.DisplayTab.prototype.initialize.apply(this,[a]);this.$video=this.$(".video-frame video");this.$source=this.$video.find("source")}});c.EditorTab=b.console.DetailTab.extend({initialize:function(a){this.editor=
b.getWidget(this.$el,".widget.code-editor-widget",b.components.CodeEditorWidget);this.$download=this.$(".editor-toolbar .download")},reload:function(){this.$download.attr("href",this.$(".editor-frame .code-editor").attr("data-path"))},resize:function(){this.editor.resize()}});c.ScriptTab=c.EditorTab.extend({jobTopic:"com/composum/sling/core/script/GroovyJobExecutor",purgeAuditKeep:6,initialize:function(a){this.profile=b.console.getProfile().get("browser","scriptView",{vertical:void 0,audit:!1});this.verticalSplit=
b.getWidget(this.$el,".split-pane.vertical-split",b.components.VerticalSplitPane);c.EditorTab.prototype.initialize.apply(this,[a]);this.$bottomArea=this.$(".detail-content .bottom-area");this.$logOutput=this.$bottomArea.find(".log-output");this.$history=this.$bottomArea.find(".history");this.$historyList=this.$history.find(".executions");this.$history.find(".toolbar .audit-link").click(_.bind(this.selectAuditNode,this));this.$history.find(".toolbar .refresh").click(_.bind(this.loadHistory,this));
this.$history.find(".toolbar .purge").click(_.bind(this.purgeHistory,this));this.$history.find(".toolbar .close").click(_.bind(this.toggleHistory,this));this.$execute=this.$(".editor-toolbar .run-script");this.$execute.click(_.bind(this.execute,this));this.$toogleHistory=this.$(".editor-toolbar .history");this.$toogleHistory.click(_.bind(this.toggleHistory,this));this.verticalSplit.setPosition(this.verticalSplit.checkPosition(this.profile.vertical));this.verticalSplit.$el.on("resize."+this.id,_.bind(this.stateChanged,
this));this.profile.audit&&this.toggleHistory()},reload:function(){c.EditorTab.prototype.reload.apply(this);this.setupStatus()},execute:function(a){this.scriptIsRunning?this.cancelJob():(this.scriptStarted(),this.startJob())},scriptStarted:function(a){this.scriptIsRunning||(this.scriptIsRunning=!0,this.$logOutput.text(""),this.$el.removeClass("error"),this.$el.addClass("running"));a&&this.logAppend(a);this.loadHistory()},scriptStopped:function(a){a&&this.logAppend(a);this.scriptIsRunning&&(this.$el.removeClass("running"),
this.scriptIsRunning=!1);this.loadHistory()},scriptError:function(a,b){this.$el.addClass("error");this.scriptStopped(a+b.statusText+(b.status?" ("+b.status+")":"")+"\n");this.delay(!0)},logAppend:function(a){var b=this.$logOutput.parent(),c=b.height(),f=this.$logOutput[0].scrollHeight,f=b.scrollTop()>f-c-30;this.$logOutput.text(this.$logOutput.text()+a);f&&(f=this.$logOutput[0].scrollHeight,b.scrollTop(f-c))},setupStatus:function(){var a=c.getCurrentPath();b.ajaxGet("/bin/cpm/core/jobcontrol.jobs.ACTIVE.json"+
a+"?topic=com/composum/sling/core/script/GroovyJobExecutor",{},_.bind(function(a,b,c){a&&0<a.length&&(this.scriptStarted(),this.logOffset=0,this.scriptJob=a[0],this.delay(!0))},this),_.bind(function(a){this.scriptError("Script status check failed: ",a)},this))},checkJob:function(){this.pollOutput(_.bind(function(){this.scriptIsRunning&&this.scriptJob&&(b.ajaxGet("/bin/cpm/core/jobcontrol.job.json/"+this.scriptJob["slingevent:eventId"],{},_.bind(function(a,b,c){this.scriptJob=a;if(this.scriptJob["slingevent:finishedState"])switch(this.scriptJob["slingevent:finishedState"]){case "SUCCEEDED":this.scriptStopped("Script finished successfully.\n");
break;case "STOPPED":this.scriptStopped("Script execution stopped.\n");break;case "ERROR":this.scriptError("Script finished with 'Error': ",{statusText:this.scriptJob["slingevent:resultMessage"]});break;default:this.scriptStopped("Script execution finished with '"+this.scriptJob["slingevent:finishedState"]+"'.\n")}},this),_.bind(function(a){this.scriptError("Script status check failed: ",a)},this)),this.delay(!0))},this))},startJob:function(){var a=c.getCurrentPath();this.delay();this.logOffset=0;
b.ajaxPost("/bin/cpm/core/jobcontrol.job.json",{"event.job.topic":"com/composum/sling/core/script/GroovyJobExecutor",reference:a,_charset_:"UTF-8"},{},_.bind(function(a,b,c){this.scriptJob=a;this.delay(!0)},this),_.bind(function(a){this.scriptError("Script start failed: ",a)},this))},cancelJob:function(){this.scriptJob&&b.ajaxDelete("/bin/cpm/core/jobcontrol.job.json/"+this.scriptJob["slingevent:eventId"],{},_.bind(function(a,b,c){this.logAppend("Script cancellation requested...\n");this.delay(!0)},
this),_.bind(function(a){this.scriptError("Script cancellation failed: ",a)},this))},pollOutput:function(a,d){d||this.scriptJob&&(d=this.scriptJob["slingevent:eventId"]);d&&b.ajaxGet("/bin/cpm/core/jobcontrol.outfile.txt/"+d,{headers:{Range:"bytes="+this.logOffset+"-"}},_.bind(function(b,d,c){this.logAppend(b);this.logOffset+=parseInt(c.getResponseHeader("Content-Length"));_.isFunction(a)&&a.call(this)},this),_.bind(function(b){this.logAppend("Script output retrieval failed: "+b.statusText+" ("+b.status+
")\n");_.isFunction(a)&&a.call(this)},this))},delay:function(a){this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0);a&&(this.timeout=setTimeout(_.bind(this.checkJob,this),"boolean"===typeof a?500:a))},toggleHistory:function(a){a&&a.preventDefault();this.$bottomArea.toggleClass("history");this.loadHistory();this.stateChanged()},loadHistory:function(a){a&&a.preventDefault();this.$historyList.html("");this.$bottomArea.hasClass("history")&&(a=c.getCurrentPath(),b.ajaxGet("/bin/cpm/core/jobcontrol.jobs.ALL.json"+
a+"?topic=com/composum/sling/core/script/GroovyJobExecutor",{},_.bind(function(a,b,c){for(b=0;b<a.length;b++)c=a[b].jobState,this.$historyList.append('<li class="'+(c?c.toLowerCase():"unknown")+'"><a href="#" data-id="'+a[b]["slingevent:eventId"]+'"><span class="time created">'+a[b]["slingevent:created"]+'</span><span class="state">'+c+'</span><span class="time finished">'+a[b]["slingevent:finishedDate"]+'</span><span class="result">'+a[b]["slingevent:resultMessage"]+"</span></a></li>");this.$historyList.find("a").click(_.bind(this.loadLog,
this))},this),_.bind(function(a){this.logAppend("Script history load failed: "+a.statusText)},this)))},loadLog:function(a){a&&a.preventDefault();var b=$(a.currentTarget);this.$logOutput.text("");this.logOffset=0;this.pollOutput(_.bind(function(){this.logAppend(b.find(".result").text())},this),b.data("id"))},purgeHistory:function(a){a&&a.preventDefault();var d=b.console.getPurgeAuditDialog();d.show(_.bind(function(){d.initDialog(this.jobTopic,c.getCurrentPath(),this.purgeAuditKeep)},this),_.bind(function(){this.loadHistory()},
this))},selectAuditNode:function(a){a&&a.preventDefault();a="/var/audit/jobs/com.composum.sling.core.script.GroovyJobExecutor"+$(a.currentTarget).data("path");$(document).trigger("path:select",[a])},stateChanged:function(){var a=_.clone(this.profile);this.profile.audit=this.$bottomArea.hasClass("history");this.profile.vertical=this.verticalSplit.getPosition();_.isEqual(a,this.profile)||(b.console.getProfile().set("browser","scriptView",this.profile),this.verticalSplit.stateChanged())}});c.JsonTab=
b.console.DetailTab.extend({initialize:function(a){this.$iframe=this.$(".embedded iframe");this.binary=b.getWidget(this.$el,".json-toolbar .binary",b.components.SelectButtonsWidget);this.depth=b.getWidget(this.$el,".json-toolbar .depth",b.components.NumberFieldWidget);this.indent=b.getWidget(this.$el,".json-toolbar .indent",b.components.NumberFieldWidget);a=b.console.getProfile().get("jsonView",void 0,{binary:"link",depth:5,indent:2});this.binary.setValue(a.binary);this.depth.setValue(a.depth);this.indent.setValue(a.indent);
this.binary.$el.on("change.json",_.bind(this.remember,this));this.depth.$textField.on("change.json",_.bind(this.remember,this));this.indent.$textField.on("change.json",_.bind(this.remember,this));this.$(".json-toolbar .reload").click(_.bind(this.reload,this));this.$download=this.$(".json-toolbar .download");this.$(".json-toolbar .upload").click(_.bind(this.upload,this))},remember:function(){var a=this.binary.getValue(),c=this.indent.getValue(),e=this.depth.getValue();b.console.getProfile().set("jsonView",
void 0,{binary:a,depth:e,indent:c});this.reload()},reload:function(){this.$download.attr("href",this.getUrl(0,0,"base64",!0));this.$iframe.attr("src",this.getUrl())},getUrl:function(a,d,e,f){void 0===a&&(a=this.depth.getValue());void 0===d&&(d=this.indent.getValue());void 0===e&&(e=this.binary.getValue());var g=c.getCurrentPath();a="/bin/cpm/nodes/node."+(f?"download.":"")+e+"."+a+".json"+g;0<d&&(a+="?indent="+d);return b.getContextUrl(a)},upload:function(){var a=b.nodes.getUploadNodeDialog();a.show(_.bind(function(){var d=
c.getCurrentPath();if(d){var e=b.getParentPath(d),d=b.getNameFromPath(d);a.initDialog(e,d)}},this))}});c.detailViewTabTypes=[{selector:"> .properties",tabType:c.PropertiesTab},{selector:"> .display",tabType:c.HtmlTab},{selector:"> .image",tabType:c.ImageTab},{selector:"> .video",tabType:c.VideoTab},{selector:"> .editor",tabType:c.EditorTab},{selector:"> .script",tabType:c.ScriptTab},{selector:"> .json",tabType:c.JsonTab},{selector:"> .acl",tabType:c.PoliciesTab},{selector:"> .versions",tabType:c.VersionsTab},
{selector:"> div",tabType:b.console.DetailTab}];c.NodeView=b.console.DetailView.extend({getProfileId:function(){return"browser"},getCurrentPath:function(){return c.current?c.current.path:void 0},getViewUri:function(){return c.current.viewUrl},getTabUri:function(a){return"/bin/browser.tab."+a+".html"},getTabTypes:function(){return c.detailViewTabTypes},initialize:function(a){b.console.DetailView.prototype.initialize.apply(this,[a]);$(document).off("path:selected.DetailView").on("path:selected.NodeView",
_.bind(this.onPathSelected,this));$(document).on("path:changed.NodeView",_.bind(this.onPathChanged,this));this.$el.resize(_.bind(this.resize,this))},onPathSelected:function(a,b){b==this.getCurrentPath()&&this.reload()},onPathChanged:function(a,b){b==this.getCurrentPath()&&this.reload()},resize:function(){this.viewWidget&&_.isFunction(this.viewWidget.resize)&&this.viewWidget.resize()},onReload:function(){c.getBreadcrumbs();this.favoriteToggle=this.$detailView.find(".favorite-toggle");this.checkFavorite();
this.favoriteToggle.click(_.bind(this.toggleFavorite,this))},checkFavorite:function(){if(c.favorites.isFavorite(this.path))return this.favoriteToggle.addClass("active"),!0;this.favoriteToggle.removeClass("active");return!1},toggleFavorite:function(a){a&&(a.preventDefault(),a.stopPropagation());this.path&&($(document).trigger("favorite:toggle",[this.path]),this.checkFavorite())}});c.nodeView=b.getView("#browser-view",c.NodeView)})(b.browser)})(window.core);
