(function(c){c.browser=c.browser||{};(function(e){e.getPropertyDialog=function(){return c.getView("#browser-view-property-dialog",window.core.browser.PropertyDialog)};e.openNewPropertyDialog=function(a){var b=e.getPropertyDialog();b.show(_.bind(function(){b.setProperty(new e.Property({path:e.getCurrentPath()}))},this),a)};e.Property=Backbone.Model.extend({defaults:{path:void 0,name:void 0,oldname:void 0,type:"String",multi:!1,value:void 0},validate:function(){var a=this.get("path"),b=this.get("name"),
d=this.get("type");return a&&0<a.trim().length&&b&&0<b.trim().length&&d&&0<d.trim().length},save:function(a,b,d){d||(d=this.toJSON());c.ajaxPut("/bin/cpm/nodes/property.json"+this.get("path"),JSON.stringify(d),{dataType:"json"},a,b)},destroy:function(a,b){c.ajaxDelete("/bin/cpm/nodes/property.remove.json"+this.get("path"),{data:JSON.stringify({names:[this.get("name")]}),dataType:"json"},a,b)}});e.PropertyDialog=c.components.Dialog.extend({initialize:function(a){c.components.Dialog.prototype.initialize.apply(this,
[a]);this.form=c.getWidget(this.el,"form.widget-form",c.components.FormWidget);this.$title=this.$("h4.modal-title");this.$path=this.$('input[name="path"]');this.$oldname=this.$('input[name="oldname"]');this.$name=this.$('input[name="name"]');this.$type=this.$('select[name="type"]');this.$subtype=this.$(".subtype");this.subtype=c.getWidget(this.$subtype,".widget.select-widget",c.components.SelectWidget);this.$multi=this.$('input[name="multi"]');this.valueWidget=c.getWidget(this.$el,".widget.property-value-widget",
e.PropertyValueWidget);this.loadTypes();this.$type.on("change",_.bind(this.typeChanged,this));this.subtype.$el.on("change",_.bind(this.typeChanged,this));this.$multi.on("change",_.bind(this.multiChanged,this));this.$name.on("change",_.bind(this.nameChanged,this));this.$delete=this.$("button.delete");this.$delete.click(_.bind(this.deleteProperty,this));this.$("button.save").click(_.bind(this.saveProperty,this));this.$("button.upload").click(_.bind(this.uploadBinary,this))},typeChanged:function(){var a=
this.valueWidget.getValue(),b=this.$type.val();this.$subtype.css("visibility","String"==b?"visible":"hidden");if(!this.busy){this.busy=!0;var d="String"==b?this.subtype.getValue():void 0;this.valueWidget.setType(b,d);this.busy=!1}"Binary"==b?(this.form.$el.removeClass("default"),this.form.$el.addClass("binary"),this.$multi.prop("checked")&&(this.$multi.prop("checked",!1),this.multiChanged()),this.$multi.closest(".form-group").addClass("invisible")):(this.form.$el.removeClass("binary"),this.form.$el.addClass("default"),
this.$multi.closest(".form-group").removeClass("invisible"));a&&this.valueWidget.setValue(a)},multiChanged:function(){if(!this.busy){this.busy=!0;var a=this.$multi.prop("checked");this.valueWidget.setMultiValue(a);this.busy=!1}},nameChanged:function(){if(!this.busy){this.busy=!0;var a=this.$name.val();this.valueWidget.nameChanged(a);this.busy=!1}},setProperty:function(a){this.reset();var b=a.get("path"),d=a.get("type"),c=a.get("name"),f=void 0;c&&(f=a.get("value"));var e="string";if("String"===d&&
f)for(var h=_.isArray(f)?f:[f],g=0;g<h.length;g++){if(0<=h[g].indexOf("</")){e="richtext";break}if(0<=h[g].indexOf("\n")){e="plaintext";break}}this.$path.val(b);this.subtype.setValue(e);c?(this.$type.val(d),this.typeChanged(),a=a.get("multi"),this.$multi.prop("checked",a),this.multiChanged(),this.$name.val(c),this.$oldname.val(c),this.$title.empty().html("Change Property"),this.$delete.removeClass("hidden")):(this.$type.val("String"),this.typeChanged(),this.$multi.prop("checked",!1),this.multiChanged(),
this.$name.val(void 0),this.$oldname.val(void 0),this.$title.empty().html("Create Property"),this.$delete.addClass("hidden"));this.nameChanged();this.valueWidget.setValue(f)},getProperty:function(){return new e.Property({path:this.$path.val(),name:this.$name.val(),oldname:this.$oldname.val(),type:this.$type.val(),multi:this.$multi.prop("checked"),value:this.valueWidget.getValue()})},uploadBinary:function(){this.submitForm(_.bind(function(){this.hide()},this))},saveProperty:function(){this.form.isValid()?
this.getProperty().save(_.bind(function(){$(document).trigger("path:changed",[e.getCurrentPath()]);this.hide()},this),_.bind(function(a){this.alert("danger","error on save property",a)},this)):this.alert("danger","name, type and value must be specified")},deleteProperty:function(){this.getProperty().destroy(_.bind(function(){$(document).trigger("path:changed",[e.getCurrentPath()]);this.hide()},this),_.bind(function(a){this.alert("danger","error on delete property",a)},this))},loadTypes:function(){c.getJson("/bin/cpm/core/system.propertyTypes.json",
_.bind(function(a){for(var b=0;b<a.length;b++)this.$type.append('<option value="'+a[b]+'">'+a[b]+"</option>")},this))}});e.PropertyValueWidget=c.components.MultiFormWidget.extend({typeMap:{String:{selector:"default",subtype:{string:"default",plaintext:"plaintext",richtext:"richtext"}},Name:{selector:"name"},URI:{selector:"default"},Boolean:{selector:"boolean"},Long:{selector:"number"},Date:{selector:"datetime"},Binary:{selector:"binary"},Decimal:{selector:"number"},Double:{selector:"number"},Path:{selector:"path"},
Reference:{selector:"reference"},WeakReference:{selector:"reference"}},initialize:function(a){c.components.MultiFormWidget.prototype.initialize.apply(this,[a]);this.setMultiValue(a.multiValue);this.setType(a.type)},nameChanged:function(a){var b=this;this.$(".widget").each(function(){this.view&&_.isFunction(this.view.nameChanged)&&this.view.nameChanged.apply(this.view,[a,b])})},setType:function(a,b){if(!this.type||this.type!=a||this.subtype!=b){this.type=a||this.type||"String";this.subtype=b;var d=
this.typeMap[this.type],c=void 0;b&&d.subtype&&(c=d.subtype[b]);c||(c=d.selector);this.setWidgetType(c)}},setWidgetType:function(a){if(!this.typeSelector||this.typeSelector!=a){this.typeSelector=a;this.$(".widget").each(function(){var a=$(this),b=a[0].view;b&&(a.addClass("hidden"),b.$input.removeAttr("name"),b.$input.removeAttr("data-rules"),_.isFunction(b.reset)&&b.reset.apply(b))});var b=this.$el.attr("data-name"),c=this.$el.attr("data-rules");this.$(".widget.property-type-"+a).each(function(){var a=
$(this),d=a[0].view;d&&(a.removeClass("hidden"),d.$input.attr("name",b||"value"),c&&d.$input.attr("data-rules",c))})}},setMultiValue:function(a){this.multiValue&&this.multiValue==a||((this.multiValue=a||!1)?(this.$el.removeClass("single-value"),this.$(".action-bar").removeClass("hidden")):(this.reset(),this.$(".action-bar").addClass("hidden"),this.$el.addClass("single-value")))},getValue:function(){var a=this.multiValue?[]:this.getWidgetValue('[name="value"]');this.multiValue&&(a=c.components.MultiFormWidget.prototype.getValue.apply(this));
return a},setValue:function(a){if(this.multiValue&&_.isArray(a)){this.reset(a.length);for(var b=this.$('[name="value"]'),c=0;c<b.length;c++)this.setWidgetValue($(b[c]),a[c])}else this.reset(),this.setWidgetValue('[name="value"]',a)}})})(c.browser)})(window.core);
