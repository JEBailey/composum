var $jscomp={scope:{},findInternal:function(a,c,b){a instanceof String&&(a=String(a));for(var e=a.length,d=0;d<e;d++){var h=a[d];if(c.call(b,h,d,a))return{i:d,v:h}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){if(b.get||b.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,b,e){if(c){b=$jscomp.global;a=a.split(".");for(e=0;e<a.length-1;e++){var d=a[e];d in b||(b[d]={});b=b[d]}a=a[a.length-1];e=b[a];c=c(e);c!=e&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6-impl","es3");
(function(a){a.browser=a.browser||{};(function(c){c.getPropertyDialog=function(){return a.getView("#browser-view-property-dialog",window.core.browser.PropertyDialog)};c.openNewPropertyDialog=function(b){var a=c.getPropertyDialog();a.show(_.bind(function(){a.setProperty(new c.Property({path:c.getCurrentPath()}))},this),b)};c.Property=Backbone.Model.extend({defaults:{path:void 0,name:void 0,oldname:void 0,type:"String",multi:!1,value:void 0},validate:function(){var b=this.get("path"),a=this.get("name"),
d=this.get("type");return b&&0<b.trim().length&&a&&0<a.trim().length&&d&&0<d.trim().length},save:function(b,e,d){d||(d=this.toJSON());a.ajaxPut("/bin/cpm/nodes/property.json"+this.get("path"),JSON.stringify(d),{dataType:"json"},b,e)},destroy:function(b,e){a.ajaxDelete("/bin/cpm/nodes/property.remove.json"+this.get("path"),{data:JSON.stringify({names:[this.get("name")]}),dataType:"json"},b,e)}});c.PropertyDialog=a.components.Dialog.extend({initialize:function(b){a.components.Dialog.prototype.initialize.apply(this,
[b]);this.form=a.getWidget(this.el,"form.widget-form",a.components.FormWidget);this.$title=this.$("h4.modal-title");this.$path=this.$('input[name="path"]');this.$oldname=this.$('input[name="oldname"]');this.$name=this.$('input[name="name"]');this.$type=this.$('select[name="type"]');this.$subtype=this.$(".subtype");this.subtype=a.getWidget(this.$subtype,".widget.select-widget",a.components.SelectWidget);this.$multi=this.$('input[name="multi"]');this.valueWidget=a.getWidget(this.$el,".widget.property-value-widget",
c.PropertyValueWidget);this.loadTypes();this.$type.on("change",_.bind(this.typeChanged,this));this.subtype.$el.on("change",_.bind(this.typeChanged,this));this.$multi.on("change",_.bind(this.multiChanged,this));this.$name.on("change",_.bind(this.nameChanged,this));this.$delete=this.$("button.delete");this.$delete.click(_.bind(this.deleteProperty,this));this.$("button.save").click(_.bind(this.saveProperty,this));this.$("button.upload").click(_.bind(this.uploadBinary,this))},typeChanged:function(){var b=
this.valueWidget.getValue(),a=this.$type.val();this.$subtype.css("visibility","String"==a?"visible":"hidden");if(!this.busy){this.busy=!0;var d="String"==a?this.subtype.getValue():void 0;this.valueWidget.setType(a,d);this.busy=!1}"Binary"==a?(this.form.$el.removeClass("default"),this.form.$el.addClass("binary"),this.$multi.prop("checked")&&(this.$multi.prop("checked",!1),this.multiChanged()),this.$multi.closest(".form-group").addClass("invisible")):(this.form.$el.removeClass("binary"),this.form.$el.addClass("default"),
this.$multi.closest(".form-group").removeClass("invisible"));b&&this.valueWidget.setValue(b)},multiChanged:function(){if(!this.busy){this.busy=!0;var b=this.$multi.prop("checked");this.valueWidget.setMultiValue(b);this.busy=!1}},nameChanged:function(){if(!this.busy){this.busy=!0;var b=this.$name.val();this.valueWidget.nameChanged(b);this.busy=!1}},setProperty:function(b){this.reset();var a=b.get("path"),d=b.get("type"),c=b.get("name"),f=void 0;c&&(f=b.get("value"));var g="string";"String"===d&&f&&
(0<=f.indexOf("\n")&&(g="plaintext"),0<=f.indexOf("</")&&(g="richtext"));this.$path.val(a);this.subtype.setValue(g);c?(this.$type.val(d),this.typeChanged(),b=b.get("multi"),this.$multi.prop("checked",b),this.multiChanged(),this.$name.val(c),this.$oldname.val(c),this.$title.empty().html("Change Property"),this.$delete.removeClass("hidden")):(this.$type.val("String"),this.typeChanged(),this.$multi.prop("checked",!1),this.multiChanged(),this.$title.empty().html("Create Property"),this.$delete.addClass("hidden"));
this.nameChanged();this.valueWidget.setValue(f)},getProperty:function(){return new c.Property({path:this.$path.val(),name:this.$name.val(),oldname:this.$oldname.val(),type:this.$type.val(),multi:this.$multi.prop("checked"),value:this.valueWidget.getValue()})},uploadBinary:function(){this.submitForm(_.bind(function(){this.hide()},this))},saveProperty:function(){this.form.isValid()?this.getProperty().save(_.bind(function(){$(document).trigger("path:changed",[c.getCurrentPath()]);this.hide()},this),
_.bind(function(b){this.alert("danger","error on save property",b)},this)):this.alert("danger","name, type and value must be specified")},deleteProperty:function(){this.getProperty().destroy(_.bind(function(){$(document).trigger("path:changed",[c.getCurrentPath()]);this.hide()},this),_.bind(function(b){this.alert("danger","error on delete property",b)},this))},loadTypes:function(){a.getJson("/bin/cpm/core/system.propertyTypes.json",_.bind(function(b){for(var a=0;a<b.length;a++)this.$type.append('<option value="'+
b[a]+'">'+b[a]+"</option>")},this))}});c.PropertyValueWidget=a.components.MultiFormWidget.extend({typeMap:{String:{selector:"default",subtype:{string:"default",plaintext:"plaintext",richtext:"richtext"}},Name:{selector:"name"},URI:{selector:"default"},Boolean:{selector:"boolean"},Long:{selector:"number"},Date:{selector:"datetime"},Binary:{selector:"binary"},Decimal:{selector:"number"},Double:{selector:"number"},Path:{selector:"path"},Reference:{selector:"reference"},WeakReference:{selector:"reference"}},
initialize:function(b){a.components.MultiFormWidget.prototype.initialize.apply(this,[b]);this.setMultiValue(b.multiValue);this.setType(b.type)},nameChanged:function(b){var a=this;this.$(".widget").each(function(){this.view&&_.isFunction(this.view.nameChanged)&&this.view.nameChanged.apply(this.view,[b,a])})},setType:function(b,a){if(!this.type||this.type!=b||this.subtype!=a){this.type=b||this.type||"String";this.subtype=a;var d=this.typeMap[this.type],c=void 0;a&&d.subtype&&(c=d.subtype[a]);c||(c=
d.selector);this.setWidgetType(c)}},setWidgetType:function(b){if(!this.typeSelector||this.typeSelector!=b){this.typeSelector=b;this.$(".widget").each(function(){var a=$(this);a.addClass("hidden");var b=a.is("input,textarea")?a:a.find("input,textarea");b.removeAttr("name");b.removeAttr("data-rules");_.isFunction(a.reset)&&a.reset.apply(a[0])});var a=this;this.$(".widget."+b).each(function(){var b=$(this);b.removeClass("hidden");b=b.is("input,textarea")?b:b.find("input,textarea");b.attr("name",a.$el.attr("data-name")||
"value");var c=a.$el.attr("data-rules");c&&b.attr("data-rules",c)})}},setMultiValue:function(b){this.multiValue&&this.multiValue==b||((this.multiValue=b||!1)?(this.$el.removeClass("single-value"),this.$(".action-bar").removeClass("hidden")):(this.reset(),this.$(".action-bar").addClass("hidden"),this.$el.addClass("single-value")))},getValue:function(){var b=this.multiValue?[]:this.getWidgetValue('[name="value"]');this.multiValue&&(b=a.components.MultiFormWidget.prototype.getValue.apply(this));return b},
setValue:function(b){if(this.multiValue&&_.isArray(b)){this.reset(b.length);for(var a=this.$('[name="value"]'),c=0;c<a.length;c++)this.setWidgetValue($(a[c]),b[c])}else this.reset(),this.setWidgetValue('[name="value"]',b)}})})(a.browser)})(window.core);
