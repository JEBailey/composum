var $jscomp={scope:{},findInternal:function(c,d,a){c instanceof String&&(c=String(c));for(var b=c.length,e=0;e<b;e++){var g=c[e];if(d.call(a,g,e,c))return{i:e,v:g}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(c,d,a){if(a.get||a.set)throw new TypeError("ES3 does not support getters and setters.");c!=Array.prototype&&c!=Object.prototype&&(c[d]=a.value)};
$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(c,d,a,b){if(d){a=$jscomp.global;c=c.split(".");for(b=0;b<c.length-1;b++){var e=c[b];e in a||(a[e]={});a=a[e]}c=c[c.length-1];b=a[c];d=d(b);d!=b&&null!=d&&$jscomp.defineProperty(a,c,{configurable:!0,writable:!0,value:d})}};
$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(c,a){return $jscomp.findInternal(this,c,a).v}},"es6-impl","es3");
(function(c){c.browser=c.browser||{};(function(d){d.Query=Backbone.View.extend({queryParamsPattern:/^[^\$]*(\$\{[^\}]+\})([^\$]*(\$\{[^\}]+\}))?([^\$]*(\$\{[^\}]+\}))?([^\$]*(\$\{[^\}]+\}))?.*$/,paramNamePattern:/^\$\{([^\}]+)\}$/,initialize:function(a){this.loadTemplates();window.setTimeout(_.bind(this.setupQueriesMenu,this),500);this.$form=this.$(".query-actions form");this.$selectMenu=this.$(".query-actions ul.select");this.$queryInput=this.$(".query-actions form input");this.$execButton=this.$(".query-actions .exec");
this.$filterButton=this.$(".query-actions .filter");this.$resultTable=this.$(".query-result table");this.$form.on("submit",_.bind(this.executeQuery,this));this.$execButton.on("click.query",_.bind(this.executeQuery,this));this.$filterButton.on("click.query",_.bind(this.toggleFilter,this));this.$filterButton.addClass(c.console.getProfile().get("query","filtered",!0)?"on":"off");this.$queryInput.on("keyup.validate",_.bind(this.queryUpdated,this));this.$queryInput.on("change.validate",_.bind(this.queryUpdated,
this));this.$queryInput.val(c.console.getProfile().get("query","current"));this.queryUpdated()},executeQuery:function(a){a.preventDefault();this.$resultTable.html('<tbody><tr><td class="pulse"><i class="fa fa-spinner fa-pulse"></i></td></tr></tbody>');var b=this.$queryInput.val();c.ajaxGet("/bin/cpm/nodes/node.query.html",{data:{query:this.prepareQuery(b),filter:this.isFiltered()?d.tree.filter:""}},_.bind(function(a){this.memorizeQuery(b);this.setupQueriesMenu();this.$resultTable.html(a);var e=this;
this.$resultTable.find("td.icon").each(function(){var a=$(this),b=a.attr("data-type");(b=c.components.treeTypes[b])||(b=c.components.treeTypes["default"]);a.find("span").addClass(b.icon)});this.$resultTable.find("td.path").each(function(){$(this).find("a").on("click",_.bind(e.pathSelected,e))})},this),_.bind(function(a){a=c.resultMessage(a,"error on execute query");this.$resultTable.html('<tbody><tr><td class="error danger">'+a+"</td></tr></tbody>")},this));return!1},prepareQuery:function(a){if(this.parameters&&
0<this.parameters.length)for(var b=0;b<this.parameters.length;b++)a=a.replace("${"+this.parameters[b]+"}",this.$('.param-input-line .form-inline [data-key="'+this.parameters[b]+'"] input').val());return a},queryUpdated:function(a){a=this.$queryInput.val();c.console.getProfile().set("query","current",a);var b=this.queryParamsPattern.exec(a);a=void 0;b&&(a=[],a[0]=this.paramNamePattern.exec(b[1])[1],3<b.length&&b[3]&&(a[1]=this.paramNamePattern.exec(b[3])[1]),5<b.length&&b[5]&&(a[2]=this.paramNamePattern.exec(b[5])[1]),
7<b.length&&b[7]&&(a[3]=this.paramNamePattern.exec(b[7])[1]));if(!_.isEqual(this.parameters,a)){(this.parameters=a)&&0<a.length?(this.$el.removeClass("params-1 params-2 params-3 params-4"),this.$el.addClass("parameters params-"+a.length)):this.$el.removeClass("parameters params-1 params-2 params-3 params-4");var e=this.$(".param-input-line"),b=e.find(".form-inline");b.html("");if(a)for(var e=e.find(".template"),d=0;d<a.length;d++){var f=e.clone();f.attr("data-key",a[d]);f.find(".key").text(a[d]);
f.removeClass("template");b.append(f)}}},memorizeQuery:function(a){var b=c.console.getProfile().get("query","history",this.queryTemplates),b=_.without(b,a),b=_.union([a],b),b=_.first(b,12);c.console.getProfile().set("query","history",b)},setupQueriesMenu:function(){this.$selectMenu.html("");var a=c.console.getProfile().get("query","history",this.queryTemplates);if(a)for(var b=0;b<a.length;b++)this.$selectMenu.append('<li><a href="#">'+a[b]+"</a></li>");this.$selectMenu.find("li>a").on("click",_.bind(this.querySelected,
this));this.$selectMenu.append('<li role="separator" class="divider"></li>');this.$selectMenu.append('<li><a href="#" class="clear">clear history</a></li>');this.$selectMenu.find("li>a.clear").on("click",_.bind(function(a){a.preventDefault();c.console.getProfile().set("query","history",void 0);this.setupQueriesMenu()},this))},querySelected:function(a){a.preventDefault();a=$(a.currentTarget);this.$queryInput.val(a.text());this.queryUpdated()},pathSelected:function(a){a.preventDefault();a=$(a.currentTarget).closest("tr").attr("data-path");
$(document).trigger("path:select",[a]);return!1},isFiltered:function(){return this.$filterButton.hasClass("on")},toggleFilter:function(a){a.preventDefault();this.isFiltered()?(this.$filterButton.removeClass("on"),this.$filterButton.addClass("off")):(this.$filterButton.removeClass("off"),this.$filterButton.addClass("on"));c.console.getProfile().set("query","filtered",this.isFiltered());return!1},loadTemplates:function(){c.getJson("/bin/cpm/nodes/node.queryTemplates.json",_.bind(function(a){this.queryTemplates=
a},this))}});d.query=c.getView("#browser-query .query-panel",d.Query)})(c.browser)})(window.core);
