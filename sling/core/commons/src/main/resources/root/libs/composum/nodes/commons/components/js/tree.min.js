(function(e){e.components=e.components||{};(function(h){h.treeTypes={"default":{icon:"fa fa-cube text-muted"},summary:{icon:"fa fa-hand-o-right text-info"},root:{icon:"fa fa-sitemap text-muted"},system:{icon:"fa fa-cogs text-muted"},activities:{icon:"fa fa-signal text-muted"},nodetypes:{icon:"fa fa-tags text-muted"},nodetype:{icon:"fa fa-tag text-muted"},versionstorage:{icon:"fa fa-history text-muted"},folder:{icon:"fa fa-folder-o"},"resource-folder":{icon:"fa fa-folder-o"},orderedfolder:{icon:"fa fa-folder text-muted"},
"package":{icon:"fa fa-file-archive-o"},"resource-package":{icon:"fa fa-file-archive-o"},component:{icon:"fa fa-puzzle-piece text-info"},container:{icon:"fa fa-cubes text-info"},element:{icon:"fa fa-cube text-info"},site:{icon:"fa fa-sitemap text-info"},siteconfiguration:{icon:"fa fa-ellipsis-h text-muted"},page:{icon:"fa fa-globe text-info"},pagecontent:{icon:"fa fa-ellipsis-h text-muted"},"page-designer":{icon:"fa fa-cube text-info"},"resource-designer":{icon:"fa fa-file-code-o text-muted"},"resource-redirect":{icon:"fa fa-share text-info"},
"resource-parsys":{icon:"fa fa-ellipsis-v text-muted"},"resource-console":{icon:"fa fa-laptop text-muted"},"resource-pckgmgr":{icon:"fa fa-laptop text-muted"},"resource-path":{icon:"fa fa-bookmark-o text-muted"},"resource-resources":{icon:"fa fa-filter text-muted"},"resource-strings":{icon:"fa fa-filter text-muted"},"resource-felix":{icon:"fa fa-cog text-muted"},"resource-guide":{icon:"fa fa-book text-muted"},"resource-servlet":{icon:"fa fa-cog text-muted"},acl:{icon:"fa fa-key text-muted"},authorizablefolder:{icon:"fa fa-diamond text-muted"},
group:{icon:"fa fa-group text-muted"},user:{icon:"fa fa-user"},linkedfile:{icon:"fa fa-link text-muted"},file:{icon:"fa fa-file-o"},resource:{icon:"fa fa-file-o"},"resource-file":{icon:"fa fa-file-o text-muted"},"file-image":{icon:"fa fa-file-image-o text-info"},"resource-image":{icon:"fa fa-file-image-o text-muted"},"file-text":{icon:"fa fa-file-text-o text-info"},"resource-text":{icon:"fa fa-file-text-o text-muted"},"file-text-plain":{icon:"fa fa-file-text-o text-info"},"resource-text-plain":{icon:"fa fa-file-code-o text-muted"},
"file-text-html":{icon:"fa fa-globe text-info"},"resource-text-html":{icon:"fa fa-file-code-o text-muted"},"file-text-css":{icon:"fa fa-file-code-o text-info"},"resource-text-css":{icon:"fa fa-file-code-o text-muted"},"file-javascript":{icon:"fa fa-file-code-o text-info"},"resource-javascript":{icon:"fa fa-file-code-o text-muted"},"file-text-javascript":{icon:"fa fa-file-code-o text-info"},"resource-text-javascript":{icon:"fa fa-file-code-o text-muted"},"file-text-x-java-source":{icon:"fa fa-file-code-o text-info"},
"resource-text-x-java-source":{icon:"fa fa-file-code-o text-muted"},"file-octet-stream":{icon:"fa fa-file-code-o text-info"},"resource-octet-stream":{icon:"fa fa-file-code-o text-muted"},"file-pdf":{icon:"fa fa-file-pdf-o text-info"},"resource-pdf":{icon:"fa fa-file-pdf-o text-muted"},"file-zip":{icon:"fa fa-file-archive-o text-info"},"resource-zip":{icon:"fa fa-file-archive-o text-muted"},"file-java-archive":{icon:"fa fa-file-archive-o text-info"},"resource-java-archive":{icon:"fa fa-file-archive-o text-muted"},
asset:{icon:"fa fa-picture-o text-info"},assetcontent:{icon:"fa fa-picture-o text-muted"},"file-binary":{icon:"fa fa-file-o text-info"},"resource-binary":{icon:"fa fa-file-o text-muted"},"resource-syntheticresourceproviderresource":{icon:"fa fa-code text-muted"}};h.Tree=Backbone.View.extend({current:function(){var a=this.getSelectedTreeNode();return a?a.original:void 0},getSelectedPath:function(){var a=this.getSelectedTreeNode();return a?a.original.path:void 0},getSelectedTreeNode:function(){var a=
this.jstree.get_selected(!0);return a&&0<a.length?a[0]:void 0},getTreeNode:function(a){a=this.nodeId(a);return this.jstree.get_node(a)},get$TreeNode:function(a){a=this.nodeId(a);return this.jstree.get_node(a,!0)},get$TreeNodeAnchor:function(a){return this.get$TreeNode(a).children(".jstree-anchor")},refresh:function(a){var b=this.current();this.delegate("refresh.jstree",_.bind(function(){this.undelegate("refresh.jstree");_.isFunction(a)?a(b):b&&this.selectNode(b.path,void 0,!0)},this));this.jstree.refresh(!0,
!0)},selectNode:function(a,b,c){this.resetSelection();if(a){var d=$.isArray(a)?a:a.split("/"),g=1,f,e=function(){if(g<d.length-1){var h=this.nodeId(_.first(d,g+1));f=this.$("#"+h);g++;f?this.jstree.is_open(f)?e.apply(this):this.jstree.is_leaf(f)?(this.undelegate("after_open.jstree"),_.isFunction(b)&&b(a)):this.jstree.open_node(f):(this.undelegate("after_open.jstree"),_.isFunction(b)&&b(a))}else{h=this.nodeId(_.first(d,d.length));if(f=this.$("#"+h))this.jstree.select_node(f,c),this.scrollIntoView(f);
this.undelegate("after_open.jstree");_.isFunction(b)&&b(a)}};this.delegate("after_open.jstree",void 0,_.bind(e,this));if(f=this.$("#"+this.nodeId(this.getRootPath())))this.jstree.is_open(f)?e.apply(this):this.jstree.is_leaf(f)?(this.undelegate("after_open.jstree"),_.isFunction(b)&&b(a)):this.jstree.open_node(f)}},resetSelection:function(){this.jstree.deselect_all()},reset:function(){this.resetSelection()},scrollIntoView:function(a){var b=this.$jstree.closest(".tree-panel");if(a=a.position()){a=a.top;
var c=b.scrollTop(),d=b.height();a<c+d/5?b.scrollTop(a-d/4):a>c+d-d/5&&b.scrollTop(a-d+d/4)}},setRootPath:function(a,b){this.rootPath=a;(void 0===b||b)&&this.refresh()},getRootPath:function(){return this.rootPath?this.rootPath:"/"},setFilter:function(a,b){this.filter=a;(void 0===b||b)&&this.refresh()},initialize:function(a){var b={plugins:["types","unique","wholerow"],core:{animation:!1,check_callback:_.bind(this.checkCallback,this),data:_.bind(this.nodeData,this),cache:!1,load_open:!0,multiple:!1,
themes:{name:"proton"},force_text:!0},types:h.treeTypes};a.dragAndDrop&&(this.dragAndDrop=_.extend(this.dragAndDrop||{},a.dragAndDrop));this.dragAndDrop&&(b.plugins=_.union(b.plugins,["dnd"]),b.dnd=this.dragAndDrop);a.contextmenu&&(this.contextmenu=_.extend(this.contextmenu||{},a.contextmenu));this.contextmenu&&(b.plugins=_.union(b.plugins,["contextmenu"]),b.contextmenu=this.contextmenu);this.$jstree=this.$el.jstree(b);this.jstree=this.$el.jstree(!0);if(_.isFunction(this.renameNode))this.$jstree.off("dblclick").on("dblclick",
".jstree-anchor",_.bind(this.editNodeName,this));this.delegateEvents({"loaded.jstree":this.initSelectedData,"redraw.jstree":this.onRedrawNode,"open_node.jstree":this.onOpenNode,"select_node.jstree":this.nodeSelected});$(document).on("path:selected."+this.nodeIdPrefix+"Tree",_.bind(this.onPathSelected,this)).on("path:inserted."+this.nodeIdPrefix+"Tree",_.bind(this.onPathInserted,this)).on("path:changed."+this.nodeIdPrefix+"Tree",_.bind(this.onPathChanged,this)).on("path:moved."+this.nodeIdPrefix+"Tree",
_.bind(this.onPathMoved,this)).on("path:deleted."+this.nodeIdPrefix+"Tree",_.bind(this.onPathDeleted,this))},initSelectedData:function(){this.initialSelect||(this.initialSelect=this.$el.attr("data-selected"));this.initialSelect&&(this.selectNode(this.initialSelect),this.initialSelect=void 0);this.undelegate("loaded.jstree")},onPathSelected:function(a,b){var c=this.getSelectedTreeNode();console.log(this.nodeIdPrefix+"tree.onPathSelected("+b+"):"+c);if(!(c&&c.original.path==b||this.busy)){this.busy=
!0;try{this.selectNode(b,_.bind(function(a){if(!this.getSelectedTreeNode()&&_.isFunction(this.onPathSelectedFailed))this.onPathSelectedFailed(a)},this))}finally{this.busy=!1}}},onPathInserted:function(a,b,c){a=this.nodeId(b);console.log(this.nodeIdPrefix+"tree.onPathInserted("+b+","+c+"):"+a);this.refreshNodeById(a)},onPathChanged:function(a,b){var c=this.nodeId(b);console.log(this.nodeIdPrefix+"tree.onPathChanged("+b+"):"+c);this.refreshNodeById(c)},onPathMoved:function(a,b,c){a=this.getTreeNodeByPath(b);
console.log(this.nodeIdPrefix+"tree.onPathMoved("+b+","+c+"):"+a);if(a){var d=(a=this.getSelectedTreeNode())&&a.original.path==b;a=e.getParentPath(b);b=e.getParentPath(c);a!=b&&(a=this.nodeId(a),this.refreshNodeById(a));b=this.nodeId(b);this.jstree.get_node(b,!1).state.loaded=!1;this.refreshNodeById(b,_.bind(function(){d&&this.selectNode(c)},this))}},onPathDeleted:function(a,b){var c=this.getTreeNodeByPath(b);console.log(this.nodeIdPrefix+"tree.onPathDeleted("+b+"):"+c);if(c){var d=this.getSelectedTreeNode(),
g=this.findNearestOfDeletion(b),f=void 0;d&&d.original.path==b&&(f=this.findNearestOfDeletion(b));this.refreshNodeById(this.getParentNodeId(c.id),_.bind(function(){if(f){var a=f.original.path;this.selectNode(a)}g&&(a=g.original.path,this.get$TreeNodeAnchor(a).focus())},this))}},findNearestOfDeletion:function(a){if(a=this.getTreeNode(a)){var b=this.jstree.get_next_dom(a,!0);if(!b||1>b.length)b=this.jstree.get_prev_dom(a,!0);if(!b||1>b.length)b=this.jstree.get_prev_dom(a);if(b&&0<b.length)return this.jstree.get_node(b[0].id)}},
nodeIdPrefix:"TR_",nodeId:function(a){!a||"string"===typeof a&&0==a.indexOf(this.nodeIdPrefix)||(_.isArray(a)&&(a=a.join("/")),a=$.base64.encode(a).replace(/=/g,"-").replace(/[/]/g,"_"),a=this.nodeIdPrefix+a);return a},nodeData:function(a,b){var c=this.dataUrlForNode(a),d=this;console.log(this.nodeIdPrefix+"tree.nodeData("+a+"): "+c);e.getJson(c,function(a){a.id=d.nodeId(a.path);if(a.children)for(var c=0;c<a.children.length;c++)a.children[c].id=d.nodeId(a.children[c].path);b.call(d.$jstree,a)})},
dataUrlForNode:function(a){var b;a.original&&a.original.path&&(b=a.original.path);b=b?window.core.encodePath(b):"/";return _.isFunction(this.dataUrlForPath)?this.dataUrlForPath(b):"/bin/cpm/nodes/node.tree.json"+b+(this.filter&&"default"!=this.filter?"?filter="+this.filter:"")},refreshNodeStateById:function(a){var b=this.jstree.get_node(a);b&&b.original&&(a=this.jstree.get_node(a,!0),0<a.length&&this.refreshNodeState(a,b));return b},refreshNodeState:function(a,b){b.original.type&&a.attr("data-type",
b.original.type);b.original.contentType&&a.attr("data-content-type",b.original.contentType);b.original.treeType&&a.addClass(b.original.treeType);if(b.original.jcrState){var c=b.original.jcrState;c.checkedOut&&c.isVersionable&&a.addClass("checked-out");c.locked&&(a.addClass("locked"),c.lock.isDeep&&a.addClass("deep-lock"),c.lock.isHolder&&a.addClass("lock-holder"))}return b},getTreeNodeByPath:function(a){a=this.nodeId(a);return this.getTreeNodeById(a)},getTreeNodeById:function(a){return this.jstree.get_node(a)},
editNodeName:function(a){a&&a.preventDefault();a=this.jstree.get_selected();if(0<a.length){a=this.jstree.get_node(a[0]);var b=a.text;this.jstree.edit(a,null,_.bind(function(a,d,e){d&&!e&&(d=a.text.replace(/^\s+/,"").replace(/\s+$/,""),d!=b&&this.renameNode(a.original,b,d))},this))}},checkCallback:function(a,b,c,d,g){return"move_node"==a?(b&&c&&(a=c.original,c=b.original,c.path!=a.path&&((g=a.path==e.getParentPath(c.path))&&d==this.getNodeIndex(b)||(_.isFunction(this.dropNode)?this.dropNode(c,a,d,
g):e.alert("warning","Drag Stop... (no implemented action)","dragged: "+c.path+"<br/>to target: "+a.path+" / pos: "+d+" ("+(g?"reorder":"move")+")")))),!1):!0},nodeSelected:function(a,b){var c=b.node.id,d=b.node.original.path,c=this.$("#"+(c?c:this.nodeId(d)));this.jstree.open_node(c);this.onNodeSelected(d,b.node,c)},onNodeSelected:function(a,b,c){this.busy||(console.log(this.nodeIdPrefix+"tree.onNodeSelected("+a+","+b+","+c+")"),$(document).trigger("path:select",[a,b,c]))},onRedrawNode:function(a,
b){for(var c=0;c<b.nodes.length;c++)this.refreshNodeStateById(b.nodes[c])},onOpenNode:function(a,b){if(b.node&&(this.refreshNodeStateById(b.node.id),b.node.children))for(var c=0;c<b.node.children.length;c++)this.refreshNodeStateById(b.node.children[c])},refreshNodeById:function(a,b){console.log(this.nodeIdPrefix+"tree.refreshNodeById("+a+")");if(!a){var c=this.jstree.get_selected();c&&0<c.length&&(a=c[0])}a&&(c=this.jstree.get_selected(),this.jstree.load_node(a,_.bind(function(){this.jstree.open_node(a,
_.bind(function(){c&&this.jstree.get_node(c)&&(this.jstree.select_node(c,!0),this.refreshNodeStateById(c));_.isFunction(b)&&b.call(this,c)},this))},this)))},getParentNodeId:function(a){var b=void 0;a&&(a=this.jstree.get_node(a))&&a.original&&(b=a.original.path,b=e.getParentPath(b),b=this.nodeId(b));return b},getNodeIndex:function(a){if(a&&(a=this.jstree.get_node(a))&&a.original){a=a.original.path;var b=e.getParentPath(a);if(b&&(b=this.nodeId(b),(b=this.jstree.get_node(b))&&b.original&&(b=b.original.children)))for(var c=
0;c<b.length;c++)if(b[c].path==a)return c}}})})(e.components)})(window.core);
