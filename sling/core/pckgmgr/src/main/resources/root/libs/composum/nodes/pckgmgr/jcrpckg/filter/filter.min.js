(function(b){b.pckgmgr=b.pckgmgr||{};(function(d){d.FilterRulesItem=b.components.MultiFormItem.extend({initialize:function(a){b.components.MultiFormItem.prototype.initialize.apply(this,[a]);this.type=b.getWidget(this.$el,".type",b.components.ComboBoxWidget);this.pattern=b.getWidget(this.$el,".pattern",b.components.TextFieldWidget)},reset:function(){this.type.setValue("include");this.pattern.setValue("")}});d.FilterRulesWidget=b.components.MultiFormWidget.extend({initialize:function(a){a=_.extend({itemType:d.FilterRulesItem},
a);b.components.MultiFormWidget.prototype.initialize.apply(this,[a])},getRules:function(){for(var a=[],c=0;c<this.itemList.length;c++){var b=this.itemList[c].type.getValue(),d=this.itemList[c].pattern.getValue();b&&d&&a.push({type:b,pattern:d})}return a},setRules:function(a){if(a){this.reset(a.length);for(var c=0;c<this.itemList.length;c++)this.itemList[c].type.setValue(a[c].type),this.itemList[c].pattern.setValue(a[c].pattern)}else this.reset(0)}});d.EditFilterDialog=b.components.Dialog.extend({initialize:function(a){b.components.Dialog.prototype.initialize.apply(this,
[a]);this.form=b.getWidget(this.el,"form.widget-form",b.components.FormWidget);this.$title=this.$(".modal-title");this.$index=this.$('input[name="index"]');this.$root=this.$('input[name="root"]');this.$importMode=this.$('select[name="importMode"]');this.filters=b.getWidget(this.$el,".widget.filter-rules-widget",d.FilterRulesWidget);this.$delete=this.$("button.delete");this.$create=this.$("button.create");this.$save=this.$("button.save");this.$delete.click(_.bind(this.deleteFilter,this));this.$create.click(_.bind(this.submitFilter,
this));this.$save.click(_.bind(this.submitFilter,this))},setFilter:function(a,c){this.$index.val(0<=a?a:-1);c?(this.form.$el.attr("action",b.getContextUrl("/bin/cpm/package.filterChange.html"+d.getCurrentPath())),this.form.$el.removeClass("create").addClass("change"),this.$title.text("Change Package Filter"),this.$root.val(c.root),this.$importMode.val(c.importMode),this.filters.setRules(c.rules)):(this.form.$el.attr("action",b.getContextUrl("/bin/cpm/package.filterAdd.html"+d.getCurrentPath())),this.form.$el.removeClass("change").addClass("create"),
this.$title.text("Create Package Filter"),this.$root.val(""),this.$importMode.val(void 0),this.filters.setRules())},submitFilter:function(a){a.preventDefault();this.form.isValid()?this.submitForm():this.alert("danger","a root path must be specified");return!1},deleteFilter:function(a){a.preventDefault();b.ajaxPost("/bin/cpm/package.filterRemove.html"+d.getCurrentPath(),{index:this.$index.val()},{},_.bind(function(){this.hide()},this),_.bind(function(a){this.alert("danger","Error on delete",a)},this));
return!1}});d.getEditFilterDialog=function(){return b.getView("#pckg-filter-dialog",d.EditFilterDialog)};d.openEditFilterDialog=function(a,c,b){var e=d.getEditFilterDialog();e.show(_.bind(function(){e.setFilter(a,c)},this),b)};d.FiltersTable=Backbone.View.extend({initialize:function(a){this.$table=this.$(".filters-table");this.$table.bootstrapTable({search:!0,showToggle:!1,striped:!0,clickToSelect:!0,singleSelect:!0,url:this.$table.data("path"),columns:[{"class":"selection",checkbox:!0,sortable:!1},
{"class":"root",field:"root",title:"Root Path / Patterns",searchable:!0,sortable:!0,width:"100%",formatter:this.formatter}]})},formatter:function(a,c,b){c.index=b;a='<div class="filter-rule" data-index="'+b+'"><div class="root-path">'+a;a+="</div>";if(c.rules){a+='<ul class="filter-rules">';for(b=0;b<c.rules.length;b++)a+='<li class="rule '+c.rules[b].type+'">',a+='<span class="type">'+c.rules[b].type+"</span>",a+='<span class="pattern">'+c.rules[b].pattern+"</span>",a+="</li>";a+="</ul>"}return a+=
"</div>"},getRowCount:function(){return this.$table.bootstrapTable("getData").length},getSelections:function(){return this.$table.bootstrapTable("getSelections")},setSelection:function(a){0<=a&&a<this.getRowCount()?this.$table.bootstrapTable("check",a):this.$table.bootstrapTable("uncheckAll")},refresh:function(a){if(0<=a)this.$table.on("load-success.bs.table.selection",_.bind(function(){this.$table.off("load-success.bs.table.selection");this.setSelection(a)},this));this.$table.bootstrapTable("refresh")}});
d.FiltersTab=b.console.DetailTab.extend({initialize:function(a){this.table=b.getWidget(this.$el,".table-container",d.FiltersTable);this.$edit=this.$(".table-toolbar .edit");this.$edit.click(_.bind(this.editFilter,this));this.$(".table-toolbar .add").click(_.bind(this.createFilter,this));this.$(".table-toolbar .remove").click(_.bind(this.deleteFilter,this));this.$(".table-toolbar .move-up").click(_.bind(this.moveFilterUp,this));this.$(".table-toolbar .move-down").click(_.bind(this.moveFilterDown,this));
this.$(".table-toolbar .reload").click(_.bind(this.refresh,this))},editFilter:function(a){a.preventDefault();(a=this.getSelectedRow())&&d.openEditFilterDialog(this.currentIndex,a,_.bind(this.refresh,this))},createFilter:function(a){a.preventDefault();this.getSelectedRow();d.openEditFilterDialog(this.currentIndex,void 0,_.bind(this.refresh,this))},deleteFilter:function(a){a.preventDefault();(a=this.getSelectedRow())&&b.ajaxPost("/bin/cpm/package.filterRemove.html"+d.getCurrentPath(),{index:a.index},
{},_.bind(function(){this.refresh()},this),_.bind(function(a){b.alert("danger","Error","Error on filter delete",a)},this))},moveFilterUp:function(a){this.moveFilter(a,"Up",-1)},moveFilterDown:function(a){this.moveFilter(a,"Down",1)},moveFilter:function(a,c,e){a.preventDefault();(a=this.getSelectedRow())&&b.ajaxPost("/bin/cpm/package.filterMove"+c+".html"+d.getCurrentPath(),{index:a.index},{},_.bind(function(){this.currentIndex+=e;this.refresh()},this),_.bind(function(a){b.alert("danger","Error","Error on filter move",
a)},this))},refresh:function(a){a&&(a.preventDefault(),this.getSelectedRow());this.table.refresh(this.currentIndex);this.getSelectedRow()},getSelectedRow:function(){var a=void 0,b=this.table.getSelections();b&&0<b.length?(a=b[0],this.currentIndex=a.index):this.currentIndex=void 0;return a},resetSelection:function(){0<=this.currentIndex&&this.table.setSelection(this.currentIndex)}})})(b.pckgmgr)})(window.core);
