(function(b){b.pckgmgr=b.pckgmgr||{};(function(a){a.pathPattern=/^\/((.+)\/)?([^\/]+)-([^\/]+)\.(zip|jar)$/;a.current={};a.getCurrentPath=function(){return a.current?a.current.path:void 0};a.setCurrentPath=function(c){a.current&&a.current.path==c||(c?b.getJson("/bin/cpm/package.tree.json"+c,void 0,void 0,_.bind(function(d){var e=a.pathPattern.exec(c);a.current={path:c,group:d.responseJSON.definition?d.responseJSON.definition.group:void 0,name:d.responseJSON.definition?d.responseJSON.definition.name:
void 0,version:d.responseJSON.definition?d.responseJSON.definition.version:void 0,extension:e?e[5]:void 0,includeVersions:d.responseJSON.definition?d.responseJSON.definition.includeVersions:void 0,node:d.responseJSON,viewUrl:b.getContextUrl("/bin/packages.view.html"+window.core.encodePath(c)),nodeUrl:b.getContextUrl("/bin/packages.html"+window.core.encodePath(c)),downloadUrl:e?b.getContextUrl("/bin/cpm/package.download.zip"+c):""};b.console.getProfile().set("pckgmgr","current",c);history.replaceState&&
history.replaceState(a.current.path,name,a.current.nodeUrl);$(document).trigger("path:selected",[c])},this)):(a.current=void 0,$(document).trigger("path:selected",[c])))};a.Pckgmgr=b.components.SplitView.extend({initialize:function(a){b.components.SplitView.prototype.initialize.apply(this,[a]);$(document).on("path:select",_.bind(this.onPathSelect,this));$(document).on("path:selected",_.bind(this.onPathSelected,this));b.unauthorizedDelegate=b.console.authorize},onPathSelect:function(c,b){b||(b=c.data.path);
a.setCurrentPath(b)},onPathSelected:function(c,b){a.tree.selectNode(b,_.bind(function(b){a.treeActions.refreshNodeState()},this))}});a.pckgmgr=b.getView("#pckgmgr",a.Pckgmgr);a.Tree=b.components.Tree.extend({nodeIdPrefix:"PM_",initialize:function(a){this.initialSelect=this.$el.attr("data-selected");this.initialSelect&&"/"!=this.initialSelect||(this.initialSelect=b.console.getProfile().get("pckgmgr","current","/"));this.filter=b.console.getProfile().get("pckgmgr","filter");b.components.Tree.prototype.initialize.apply(this,
[a])},dataUrlForPath:function(a){return"/bin/cpm/package.tree.json"+a},onNodeSelected:function(a,b,e){$(document).trigger("path:select",[a])}});a.tree=b.getView("#package-tree",a.Tree);a.TreeActions=Backbone.View.extend({initialize:function(b){this.tree=a.tree;this.$("button.refresh").on("click",_.bind(this.refreshTree,this));this.$("button.create").on("click",_.bind(this.createPackage,this));this.$("button.delete").on("click",_.bind(this.deletePackage,this));this.$("button.upload").on("click",_.bind(this.uploadPackage,
this));this.$download=this.$("a.download")},refreshNodeState:function(){a.current?this.$download.attr("href",a.current.downloadUrl):this.$download.attr("href","")},createPackage:function(c){var d=a.getCreatePackageDialog();d.show(_.bind(function(){var a=this.tree.current(),c=a.path;"package"==a.type&&(c=b.getParentPath(c));a&&d.initGroup(c.substring(1))},this))},deletePackage:function(b){if(a.current.name){var c=a.getDeletePackageDialog();c.show(_.bind(function(){c.setPackage(a.current)},this))}},
uploadPackage:function(b){a.getUploadPackageDialog().show(_.bind(function(){},this))},downloadPackage:function(a){},refreshTree:function(a){this.tree.refresh()}});a.treeActions=b.getView(".tree-actions",a.TreeActions);a.detailViewTabTypes=[{selector:"> .package",tabType:a.JcrPackageTab},{selector:"> .filters",tabType:a.FiltersTab},{selector:"> .coverage",tabType:a.CoverageTab},{selector:"> .options",tabType:a.OptionsTab},{selector:"> .group",tabType:a.GroupTab},{selector:"> div",tabType:b.console.DetailTab}];
a.DetailView=b.console.DetailView.extend({getProfileId:function(){return"pckgmgr"},getCurrentPath:function(){return a.current?a.current.path:void 0},getViewUri:function(){return a.current.viewUrl},getTabUri:function(a){return"/bin/packages.tab."+a+".html"},getTabTypes:function(){return a.detailViewTabTypes},initialize:function(a){b.console.DetailView.prototype.initialize.apply(this,[a])}});a.detailView=b.getView("#pckgmgr-view",a.DetailView)})(b.pckgmgr)})(window.core);
